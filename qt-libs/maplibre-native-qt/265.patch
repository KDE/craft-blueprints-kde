From 0039d039aa153a63f97e9c398f1b658b9b64d488 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Jonah=20Br=C3=BCchert?= <jbb@kaidan.im>
Date: Sun, 16 Nov 2025 03:38:03 +0100
Subject: [PATCH 1/2] Make sure to install to plugin directories used by Qt

---
 CMakeLists.txt                      | 14 ++++++++++++++
 src/location/plugins/CMakeLists.txt | 20 ++++++++++----------
 src/quick/plugins/CMakeLists.txt    | 12 ++++++------
 3 files changed, 30 insertions(+), 16 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 41c3ae1c..782cd09f 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -53,6 +53,20 @@ if(MLN_QT_WITH_LTO)
     endif()
 endif()
 
+# Try to use ECM (extra-cmake-modules) to query directories used by Qt
+find_package(ECM 6.0.0 NO_MODULE)
+if(ECM_FOUND)
+    set(CMAKE_MODULE_PATH ${ECM_MODULE_PATH} ${CMAKE_SOURCE_DIR}/cmake)
+    include(KDEInstallDirs)
+    set(MLN_QT_PLUGIN_DIR ${KDE_INSTALL_QTPLUGINDIR})
+    set(MLN_QML_MODULE_DIR ${KDE_INSTALL_QMLDIR})
+else()
+    message(STATUS "Can not query plugin directories used by Qt installation because extra-cmake-modules is not available. Using defaults.")
+    include(GNUInstallDirs)
+    set(MLN_QT_PLUGIN_DIR ${KDE_INSTALL_QTPLUGINDIR} "${CMAKE_INSTALL_LIBDIR}/plugins/")
+    set(MLN_QML_MODULE_DIR ${KDE_INSTALL_QMLDIR} "${CMAKE_INSTALL_LIBDIR}/qml")
+endif()
+
 # Find Qt
 if("${QT_VERSION_MAJOR}" STREQUAL "")
     find_package(QT NAMES Qt6 COMPONENTS Core REQUIRED)
diff --git a/src/location/plugins/CMakeLists.txt b/src/location/plugins/CMakeLists.txt
index 94cbc851..d9d8d069 100644
--- a/src/location/plugins/CMakeLists.txt
+++ b/src/location/plugins/CMakeLists.txt
@@ -70,10 +70,10 @@ install(
 install(
     TARGETS ${MLN_QT_GEOSERVICES_PLUGIN} ${GeoServicesPluginOutputTargets}
     EXPORT ${MLN_QT_NAME}LocationPluginGeoServicesTargets
-    ARCHIVE DESTINATION "plugins/geoservices"
-    LIBRARY DESTINATION "plugins/geoservices"
-    OBJECTS DESTINATION "plugins/geoservices"
-    RUNTIME DESTINATION "plugins/geoservices"
+    ARCHIVE DESTINATION "${MLN_QT_PLUGIN_DIR}/geoservices"
+    LIBRARY DESTINATION "${MLN_QT_PLUGIN_DIR}/geoservices"
+    OBJECTS DESTINATION "${MLN_QT_PLUGIN_DIR}/geoservices"
+    RUNTIME DESTINATION "${MLN_QT_PLUGIN_DIR}/geoservices"
 )
 
 # QtLocation QML extension plugin
@@ -165,18 +165,18 @@ install(
 install(
     TARGETS ${MLN_QT_QML_PLUGIN_LOCATION} ${QmlLocationPluginOutputTargets}
     EXPORT ${MLN_QT_NAME}LocationPluginQmlTargets
-    ARCHIVE DESTINATION "qml/MapLibre/Location"
-    LIBRARY DESTINATION "qml/MapLibre/Location"
-    OBJECTS DESTINATION "qml/MapLibre/Location"
-    RUNTIME DESTINATION "qml/MapLibre/Location"
+    ARCHIVE DESTINATION "${MLN_QML_MODULE_DIR}/MapLibre/Location"
+    LIBRARY DESTINATION "${MLN_QML_MODULE_DIR}/MapLibre/Location"
+    OBJECTS DESTINATION "${MLN_QML_MODULE_DIR}/MapLibre/Location"
+    RUNTIME DESTINATION "${MLN_QML_MODULE_DIR}/MapLibre/Location"
 )
 install(
     FILES
         "${CMAKE_CURRENT_BINARY_DIR}/MapLibre/Location/qmldir"
-    DESTINATION "qml/MapLibre/Location"
+    DESTINATION "${MLN_QML_MODULE_DIR}/MapLibre/Location"
 )
 install(
     FILES
         "${CMAKE_CURRENT_BINARY_DIR}/MapLibre/Location/${MLN_QT_QML_PLUGIN_LOCATION}.qmltypes"
-    DESTINATION "qml/MapLibre/Location"
+    DESTINATION "${MLN_QML_MODULE_DIR}/MapLibre/Location"
 )
diff --git a/src/quick/plugins/CMakeLists.txt b/src/quick/plugins/CMakeLists.txt
index 7540b508..117be0c0 100644
--- a/src/quick/plugins/CMakeLists.txt
+++ b/src/quick/plugins/CMakeLists.txt
@@ -83,18 +83,18 @@ install(
 install(
     TARGETS ${MLN_QT_QML_PLUGIN} ${QmlPluginOutputTargets}
     EXPORT ${MLN_QT_NAME}QuickPluginQmlTargets
-    ARCHIVE DESTINATION "qml/MapLibre"
-    LIBRARY DESTINATION "qml/MapLibre"
-    OBJECTS DESTINATION "qml/MapLibre"
-    RUNTIME DESTINATION "qml/MapLibre"
+    ARCHIVE DESTINATION "${MLN_QML_MODULE_DIR}/MapLibre"
+    LIBRARY DESTINATION "${MLN_QML_MODULE_DIR}/MapLibre"
+    OBJECTS DESTINATION "${MLN_QML_MODULE_DIR}/MapLibre"
+    RUNTIME DESTINATION "${MLN_QML_MODULE_DIR}/MapLibre"
 )
 install(
     FILES
         "${CMAKE_CURRENT_BINARY_DIR}/MapLibre/qmldir"
-    DESTINATION "qml/MapLibre"
+    DESTINATION "${MLN_QML_MODULE_DIR}/MapLibre"
 )
 install(
     FILES
         "${CMAKE_CURRENT_BINARY_DIR}/MapLibre/${MLN_QT_QML_PLUGIN}.qmltypes"
-    DESTINATION "qml/MapLibre"
+    DESTINATION "${MLN_QML_MODULE_DIR}/MapLibre"
 )
